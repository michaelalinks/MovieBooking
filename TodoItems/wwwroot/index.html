<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/site.css" media=”screen” />
    <title>Movie Booking Page</title>
</head>
<body>
    <div class="page_title">
        <h1 style="text-align:center">Movie Booking Page</h1>

    </div>

    <div>
        <form class="form-inline" action="#" style="text-align:center">
            <label for="fname">First Name</label>
            <input type="text" class="form-control" id="fname" placeholder="Your First Name">
            <label for="lname">Last Name</label>
            <input type="text" class="form-control" id="lname" placeholder="Your Last Name">
            <button type="submit" class="btn btn-primary">Finish</button>
        </form>


                    <script>
                /****************************************************************************
                 * Add a new TodoItem.
                 *
                 * 1) send an update to the DB
                 * 2) if successful then add the item to the list
                 ****************************************************************************/
                function addNewTodoItem(newItemValue) {

                    // Get the value from the Input field in the FORM
                    let todoValue = document.getElementById("newTodoDescription").value.trim();

                    // Check that a value have added
                    if (todoValue === "") {
                        alert("Please enter a value for your item");
                    }
                    createTodoItem(todoValue);
                    document.getElementById("newTodoDescription").value = "";
                }

                /****************************************************************************
                 * This function will add the a new todo item to the UL element
                 * Specifically this will add:
                 *
                 *   <li>the item description<span class="close">X</>li>
                 *
                 * 1) add to DB
                 * 2) if successful then add the item to the list
                 *
                 ****************************************************************************/
                function addTodoItemToDisplay(item) {
                    let todoItemNode = document.createElement("li");
                    let descriptionTextNode = document.createTextNode(item["description"]);
                    todoItemNode.appendChild(descriptionTextNode);

                    document.getElementById("todoList").appendChild(todoItemNode);

                    let tickSpanNode = document.createElement("SPAN");
                    let tickText = document.createTextNode("\u2713");  // \u2713 is unicode for the tick symbol
                    tickSpanNode.appendChild(tickText);
                    todoItemNode.appendChild(tickSpanNode);
                    tickSpanNode.className = "tickHidden";

                    let closeSpanNode = document.createElement("SPAN");
                    let closeText = document.createTextNode("X");
                    closeSpanNode.className = "close";
                    closeSpanNode.appendChild(closeText);
                    todoItemNode.appendChild(closeSpanNode);

                    closeSpanNode.onclick = function (event) {
                        // When the use press the "X" button, the click event is normally also passed to its parent element.
                        // (i.e. the element containing the <SPAN>). In the case the LI element that is holding the TodoItem
                        // which would have resulted in a toggle of item between "DONE" and "NEW"
                        //
                        // stopPropagation() tells the event not to propagate
                        event.stopPropagation();

                        if (confirm("Are you sure that you want to delete " + item.description + "?")) {
                            deleteTodoItem(item["id"]);

                            // Remove the HTML list element that is holding this todo item
                            todoItemNode.remove();
                        }
                    }

                    todoItemNode.onclick = function () {
                        if (item["status"] === "NEW") {
                            item["status"] = "DONE"
                        } else {
                            item["status"] = "NEW"
                        }

                        updateTodoItem(item);

                        todoItemNode.classList.toggle("checked");
                        tickSpanNode.classList.toggle("tickVisible");
                    }

                    if (item["status"] !== "NEW") {
                        todoItemNode.classList.toggle("checked");
                        tickSpanNode.classList.toggle("tickVisible");
                    }
                }

                /****************************************************************************
                 * CRUD functions calling the REST API
                 ****************************************************************************/

                function createTodoItem(todoItemDescription) {

                    // Create a new JSON object for the new item with the status of NEW
                    // Since the id is generated by the microservice, we will use -1 as a dummy
                    // If the POST is successful the microservice will store the new item in the database
                    // and returns a JSON via the response with the generated id for the new item
                    const newItem = {"description": todoItemDescription, "status": "NEW"};
                    const requestOptions = {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newItem)
                    };
                    fetch('http://localhost:5066/todo', requestOptions)
                        // get the JSON content from the response
                        .then((response) => {
                            if (!response.ok) {
                                alert("An error has occurred.  Unable to create the TODO item")
                                throw response.status;
                            } else return response.json();
                        })

                        // add the item to the UL element so that it will appear in the browser
                        .then(item => addTodoItemToDisplay(item));
                }

                // Load the list - expecting an array of todo_items to be returned
                function readTodoItems() {
                    fetch('http://localhost:5066/todo')
                        // get the JSON content from the response
                        .then((response) => {
                            if (!response.ok) {
                                alert("An error has occurred.  Unable to read the TODO list")
                                throw response.status;
                            } else return response.json();
                        })
                        // Add the items to the UL element so that it can be seen
                        // As items is an array, we will the array.map function to through the array and add item to the UL element
                        // for display
                        .then(items => items.map(item => addTodoItemToDisplay(item)));
                }

                function updateTodoItem(item) {
                    const requestOptions = {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(item)
                    };
                    fetch('http://localhost:5066/todo/' + item.id, requestOptions)
                        .then((response) => {
                            if (!response.ok) {
                                alert("An error has occurred.  Unable to UPDATE the TODO item")
                                throw response.status;
                            } else return response.json();
                        })
                }

                function deleteTodoItem(todoItemId) {
                    fetch("http://localhost:5066/todo/" + todoItemId, {method: 'DELETE'})
                        .then((response) => {
                            if (!response.ok) {
                                alert("An error has occurred.  Unable to DELETE the TODO item")
                                throw response.status;
                            } else return response.json();
                        })
                }
                    </script>
    </div>


</body>
</html>